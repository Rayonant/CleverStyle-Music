// Generated by CoffeeScript 1.4.0

/**
 * @package     CleverStyle Music
 * @category    app
 * @author      Nazar Mokrynskyi <nazar@mokrynskyi.com>
 * @copyright   Copyright (c) 2014, Nazar Mokrynskyi
 * @license     MIT License, see license.txt
*/


(function() {
  var music_library;

  music_library = cs.music_library;

  cs.music_playlist = {
    get_all: function(callback) {
      var playlist;
      callback = (callback || function() {}).bind(this);
      playlist = localStorage.playlist;
      if (playlist) {
        playlist = JSON.parse(playlist);
        if (playlist != null ? playlist.length : void 0) {
          callback(playlist);
          return;
        }
      }
      return this.refresh(function() {
        return this.get_all(callback);
      });
    },
    current: function(callback) {
      var playlist, position;
      callback = (callback || function() {}).bind(this);
      playlist = localStorage.playlist;
      if (playlist) {
        playlist = JSON.parse(playlist);
        if (playlist != null ? playlist.length : void 0) {
          position = localStorage.position || 0;
          if (position < playlist.length) {
            localStorage.position = position;
            callback(playlist[position]);
            return;
          }
        }
      }
      this.refresh(function() {
        return this.next(callback);
      });
    },
    set_current: function(position) {
      return localStorage.position = position;
    },
    set_current_id: function(id) {
      return this.get_all(function(all) {
        return localStorage.position = all.indexOf(id);
      });
    },
    prev: function(callback) {
      var playlist, position;
      callback = (callback || function() {}).bind(this);
      playlist = localStorage.playlist;
      if (playlist) {
        playlist = JSON.parse(playlist);
        if (playlist != null ? playlist.length : void 0) {
          position = localStorage.position || -1;
          if (position > 0) {
            --position;
            localStorage.position = position;
            callback(playlist[position]);
          }
        }
      }
    },
    next: function(callback) {
      var playlist, position;
      callback = (callback || function() {}).bind(this);
      playlist = localStorage.playlist;
      if (playlist) {
        playlist = JSON.parse(playlist);
        if (playlist != null ? playlist.length : void 0) {
          position = localStorage.position || -1;
          if (position < (playlist.length - 1)) {
            ++position;
            localStorage.position = position;
            callback(playlist[position]);
            return;
          } else if (cs.music_settings.repeat === 'none') {
            return;
          }
        }
      }
      this.refresh(function() {
        return this.next(callback);
      });
    },
    set: function(all, callback) {
      localStorage.original_playlist = JSON.stringify(all);
      delete localStorage.playlist;
      return this.refresh(callback);
    },
    append: function(new_items) {
      var original_playlist, playlist;
      original_playlist = JSON.parse(localStorage.original_playlist);
      original_playlist = original_playlist.concat(new_items).unique();
      localStorage.original_playlist = JSON.stringify(original_playlist);
      if (cs.music_settings.shuffle) {
        new_items.shuffle();
      }
      playlist = JSON.parse(localStorage.playlist);
      playlist = playlist.concat(new_items).unique();
      return localStorage.playlist = JSON.stringify(playlist);
    },
    refresh: function(callback) {
      var playlist,
        _this = this;
      callback = (callback || function() {}).bind(this);
      playlist = JSON.parse(localStorage.original_playlist || '[]');
      if (playlist.length) {
        if (cs.music_settings.shuffle) {
          playlist.shuffle();
        }
        localStorage.playlist = JSON.stringify(playlist);
        delete localStorage.position;
        callback(playlist);
      } else {
        music_library.get_all(function(all) {
          var i, value, _i, _len;
          if (all.length) {
            for (i = _i = 0, _len = all.length; _i < _len; i = ++_i) {
              value = all[i];
              all[i] = value.id;
            }
            return _this.set(all, callback);
          } else if (confirm(_('library-empty-want-to-rescan'))) {
            $(document.body).addClass('library-rescan');
            return document.querySelector('cs-music-library-rescan').open();
          }
        });
      }
    }
  };

}).call(this);
